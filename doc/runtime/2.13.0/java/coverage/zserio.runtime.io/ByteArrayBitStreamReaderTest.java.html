<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ByteArrayBitStreamReaderTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Zserio Java Runtime Library</a> &gt; <a href="index.source.html" class="el_package">zserio.runtime.io</a> &gt; <span class="el_source">ByteArrayBitStreamReaderTest.java</span></div><h1>ByteArrayBitStreamReaderTest.java</h1><pre class="source lang-java linenums">package zserio.runtime.io;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertThrows;
import org.junit.jupiter.api.Test;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.math.BigInteger;
import javax.imageio.stream.ImageOutputStream;
import javax.imageio.stream.MemoryCacheImageOutputStream;

<span class="fc" id="L14">public class ByteArrayBitStreamReaderTest</span>
{
    @Test
    public void bitBufferConstructor() throws IOException
    {
<span class="fc" id="L19">        final BitBuffer bitBuffer = new BitBuffer(new byte[]{(byte)0xAE, (byte)0xEA, (byte)0x80}, 17);</span>

<span class="fc" id="L21">        try (final BitStreamReader reader = new ByteArrayBitStreamReader(bitBuffer))</span>
        {
<span class="fc" id="L23">            assertEquals(bitBuffer.getBitSize(), reader.getBufferBitSize());</span>
<span class="fc" id="L24">            assertEquals(0xAEE, reader.readBits(12));</span>
<span class="fc" id="L25">            assertEquals(0x0A, reader.readBits(4));</span>
<span class="fc" id="L26">            assertEquals(0x01, reader.readBits(1));</span>

            // check eof
<span class="pc" id="L29">            assertThrows(IOException.class, () -&gt; reader.readBits(1));</span>
        }
<span class="fc" id="L31">    }</span>

    @Test
    public void bitBufferConstructorOverflow() throws IOException
    {
<span class="fc" id="L36">        final BitBuffer bitBuffer = new BitBuffer(new byte[]{(byte)0xFF, (byte)0xFF, (byte)0xF0}, 19);</span>
<span class="fc" id="L37">        try (final BitStreamReader reader = new ByteArrayBitStreamReader(bitBuffer))</span>
        {
<span class="fc" id="L39">            assertEquals(bitBuffer.getBitSize(), reader.getBufferBitSize());</span>

<span class="pc" id="L41">            assertThrows(IOException.class, () -&gt; reader.readBits(20));</span>
        }
<span class="fc" id="L43">    }</span>

    @Test
    public void bitConstructor() throws IOException
    {
<span class="fc" id="L48">        final long bitSize = 17;</span>
<span class="fc" id="L49">        final byte[] buffer = new byte[]{(byte)0xAE, (byte)0xEA, (byte)0x80};</span>

<span class="fc" id="L51">        try (final BitStreamReader reader = new ByteArrayBitStreamReader(buffer, bitSize))</span>
        {
<span class="fc" id="L53">            assertEquals(bitSize, reader.getBufferBitSize());</span>
<span class="fc" id="L54">            assertEquals(0xAEE, reader.readBits(12));</span>
<span class="fc" id="L55">            assertEquals(0x0A, reader.readBits(4));</span>
<span class="fc" id="L56">            assertEquals(0x01, reader.readBits(1));</span>

            // check eof
<span class="pc" id="L59">            assertThrows(IOException.class, () -&gt; reader.readBits(1));</span>
        }
<span class="fc" id="L61">    }</span>

    @Test
    public void bitConstructorOverflow() throws IOException
    {
<span class="fc" id="L66">        final long bitSize = 19;</span>
<span class="fc" id="L67">        final byte[] buffer = new byte[]{(byte)0xFF, (byte)0xFF, (byte)0xF0};</span>
<span class="fc" id="L68">        try (final BitStreamReader reader = new ByteArrayBitStreamReader(buffer, bitSize))</span>
        {
<span class="fc" id="L70">            assertEquals(bitSize, reader.getBufferBitSize());</span>

<span class="pc" id="L72">            assertThrows(IOException.class, () -&gt; reader.readBits(20));</span>
        }
<span class="fc" id="L74">    }</span>

    @Test
    public void readUnalignedData() throws IOException
    {
        // number expected to read at offset
<span class="fc" id="L80">        final int testValue = 123;</span>

<span class="fc bfc" id="L82" title="All 2 branches covered.">        for (int offset = 0; offset &lt;= 64; ++offset)</span>
        {
            // write test value at offset to data buffer
<span class="fc" id="L85">            final byte[] buffer = new byte[(8 + offset + 7) / 8];</span>
<span class="fc" id="L86">            buffer[offset / 8] = (byte)(testValue &gt;&gt; (offset % 8));</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (offset % 8 != 0) // don't write behind the buffer</span>
<span class="fc" id="L88">                buffer[offset / 8 + 1] = (byte)(testValue &lt;&lt; (8 - offset % 8));</span>

<span class="fc" id="L90">            final BitBuffer bitBuffer = new BitBuffer(buffer, 8 + offset);</span>
<span class="fc" id="L91">            try (final BitStreamReader reader = new ByteArrayBitStreamReader(bitBuffer))</span>
            {
                // read offset bits
<span class="fc bfc" id="L94" title="All 2 branches covered.">                if (offset != 0) // java reader cannot read 0 bits</span>
<span class="fc" id="L95">                    assertEquals(0, reader.readBits(offset));</span>

                // read magic number
<span class="fc" id="L98">                assertEquals(testValue, reader.readBits(8), &quot;offset: &quot; + offset);</span>

                // check eof
<span class="pc" id="L101">                assertThrows(IOException.class, () -&gt; reader.readBits(1), &quot;offset: &quot; + offset + &quot;!&quot;);</span>
            }
        }
<span class="fc" id="L104">    }</span>

    /**
     * Test the exception in the protected readRange method.
     */
    @Test
    public void rangeMinException() throws IOException
    {
<span class="fc" id="L112">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="pc" id="L116">                assertThrows(IllegalArgumentException.class, () -&gt; reader.readBits(-1));</span>
<span class="fc" id="L117">            }</span>
        });
<span class="fc" id="L119">    }</span>

    /**
     * Test the exception in the protected readRange method.
     */
    @Test
    public void rangeMaxException() throws IOException
    {
<span class="fc" id="L127">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="pc" id="L131">                assertThrows(IllegalArgumentException.class, () -&gt; reader.readBits(65));</span>
<span class="fc" id="L132">            }</span>
        });
<span class="fc" id="L134">    }</span>

    /**
     * Test the bit offset getter.
     */
    @Test
    public void bitOffset() throws IOException
    {
<span class="fc" id="L142">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L146">                assertEquals(0, reader.getBitOffset());</span>
<span class="fc" id="L147">            }</span>
        });
<span class="fc" id="L149">    }</span>

    @Test
    public void readByte() throws IOException
    {
<span class="fc" id="L154">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
                byte b;
                long pos;
                long bytePos;

<span class="fc" id="L162">                b = reader.readByte();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">                assertTrue(b == 6 * 16 + 7);</span>
<span class="fc" id="L164">                b = reader.readByte();</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">                assertTrue(b == 8 * 16 + 9 - 256);</span>
<span class="fc" id="L166">                pos = reader.getBitPosition();</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                assertTrue(pos == 16);</span>
<span class="fc" id="L168">                bytePos = reader.getBytePosition();</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">                assertTrue(bytePos == 2);</span>

<span class="fc" id="L171">                reader.setBitPosition(0);</span>

<span class="fc" id="L173">                b = reader.readByte();</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">                assertTrue(b == 6 * 16 + 7);</span>
<span class="fc" id="L175">                b = reader.readByte();</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">                assertTrue(b == 8 * 16 + 9 - 256);</span>
<span class="fc" id="L177">                pos = reader.getBitPosition();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">                assertTrue(pos == 16);</span>
<span class="fc" id="L179">                bytePos = reader.getBytePosition();</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                assertTrue(bytePos == 2);</span>
<span class="fc" id="L181">            }</span>
        });
<span class="fc" id="L183">    }</span>

    @Test
    public void readUnsignedByte() throws IOException
    {
<span class="fc" id="L188">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L192">                int b = reader.readByte();</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                assertTrue(b == 6 * 16 + 7);</span>
<span class="fc" id="L194">                b = reader.readByte();</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">                assertTrue(b == 8 * 16 + 9 - 256);</span>
<span class="fc" id="L196">                long pos = reader.getBitPosition();</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                assertTrue(pos == 16);</span>
<span class="fc" id="L198">                long bytePos = reader.getBytePosition();</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">                assertTrue(bytePos == 2);</span>

<span class="fc" id="L201">                reader.setBitPosition(0);</span>

<span class="fc" id="L203">                b = reader.readByte();</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                assertTrue(b == 6 * 16 + 7);</span>
<span class="fc" id="L205">                b = reader.readByte();</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                assertTrue(b == 8 * 16 + 9 - 256);</span>
<span class="fc" id="L207">                pos = reader.getBitPosition();</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">                assertTrue(pos == 16);</span>
<span class="fc" id="L209">                bytePos = reader.getBytePosition();</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">                assertTrue(bytePos == 2);</span>
<span class="fc" id="L211">            }</span>
        });
<span class="fc" id="L213">    }</span>

    @Test
    public void readUnsignedInt1() throws IOException
    {
<span class="fc" id="L218">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L222">                final short uint8 = reader.readUnsignedByte();</span>
<span class="fc" id="L223">                assertEquals(uint8, 0x67);</span>
<span class="fc" id="L224">                final long uint32 = reader.readUnsignedInt();</span>
<span class="fc" id="L225">                assertEquals(uint32, 0x891234CDL);</span>
<span class="fc" id="L226">            }</span>
        });
<span class="fc" id="L228">    }</span>

    @Test
    public void readUnsignedShort() throws IOException
    {
<span class="fc" id="L233">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L237">                final short uint8 = reader.readUnsignedByte();</span>
<span class="fc" id="L238">                assertEquals(uint8, 0x67);</span>
<span class="fc" id="L239">                final int uint16 = reader.readUnsignedShort();</span>
<span class="fc" id="L240">                assertEquals(uint16, 0x8912);</span>
<span class="fc" id="L241">            }</span>
        });
<span class="fc" id="L243">    }</span>

    @Test
    public void bitStreamReader() throws IOException
    {
<span class="fc" id="L248">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L252">                long v = reader.readBits(2);</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">                assertTrue(v == 6 &gt;&gt; 2);</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 2);</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 0);</span>
<span class="fc" id="L256">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">                assertTrue(v == (6 &amp; 0x03));</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 4);</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 0);</span>
<span class="fc" id="L260">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">                assertTrue(v == 7 &gt;&gt; 2);</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 6);</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 0);</span>
<span class="fc" id="L264">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">                assertTrue(v == (7 &amp; 0x03));</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 8);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="fc" id="L268">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">                assertTrue(v == 8 &gt;&gt; 2);</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 10);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="fc" id="L272">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                assertTrue(v == (8 &amp; 0x03));</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 12);</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="fc" id="L276">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                assertTrue(v == 9 &gt;&gt; 2);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 14);</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="fc" id="L280">                v = reader.readBits(2);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">                assertTrue(v == (9 &amp; 0x03));</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 16);</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 2);</span>
<span class="fc" id="L284">            }</span>
        });
<span class="fc" id="L286">    }</span>

    @Test
    public void readByteNotAligned() throws IOException
    {
<span class="fc" id="L291">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
                long v;
                int uint8;
<span class="fc" id="L297">                v = reader.readBits(4);</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">                assertTrue(v == 6);</span>
<span class="fc" id="L299">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">                assertTrue(uint8 == 0x78);</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 12);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="fc" id="L303">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">                assertTrue(uint8 == 0x91);</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 20);</span>
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 2);</span>
<span class="fc" id="L307">            }</span>
        });
<span class="fc" id="L309">    }</span>

    @Test
    public void setBitPosition() throws IOException
    {
<span class="fc" id="L314">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
                short s;
<span class="fc" id="L319">                final short t = 0x6789;</span>
                int uint8;
<span class="fc" id="L321">                s = reader.readShort();</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">                assertTrue(s == t);</span>

<span class="fc" id="L324">                reader.setBitPosition(0);</span>
<span class="fc" id="L325">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">                assertTrue(uint8 == 0x67);</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 8);</span>

<span class="fc" id="L330">                reader.setBitPosition(1);</span>
<span class="fc" id="L331">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                assertTrue(uint8 == (t &amp; 0x7F80) &gt;&gt; 7);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 9);</span>

<span class="fc" id="L336">                reader.setBitPosition(2);</span>
<span class="fc" id="L337">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">                assertTrue(uint8 == (t &amp; 0x3FC0) &gt;&gt; 6);</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 10);</span>

<span class="fc" id="L342">                reader.setBitPosition(3);</span>
<span class="fc" id="L343">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">                assertTrue(uint8 == (t &amp; 0x1FE0) &gt;&gt; 5);</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 11);</span>

<span class="fc" id="L348">                reader.setBitPosition(4);</span>
<span class="fc" id="L349">                uint8 = reader.readUnsignedByte();</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">                assertTrue(uint8 == 0x78);</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">                assertTrue(reader.getBytePosition() == 1);</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">                assertTrue(reader.getBitPosition() == 12);</span>
<span class="fc" id="L353">            }</span>
        });
<span class="fc" id="L355">    }</span>

    @Test
    public void signedBitfield1() throws IOException
    {
<span class="fc" id="L360">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc" id="L364">                writer.writeByte(-1);</span>
<span class="fc" id="L365">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L370">                assertEquals(-1L, reader.readSignedBits(3));</span>
<span class="fc" id="L371">                assertEquals(-1L, reader.readSignedBits(2));</span>
<span class="fc" id="L372">                assertEquals(-1L, reader.readSignedBits(3));</span>
<span class="fc" id="L373">            }</span>
        });
<span class="fc" id="L375">    }</span>

    @Test
    public void signedBitfield2() throws IOException
    {
<span class="fc" id="L380">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L382">            writer.writeShort((short)-10000);</span>
<span class="fc" id="L383">            final byte[] blob = writer.toByteArray();</span>
<span class="fc" id="L384">            assertEquals(2, blob.length);</span>

<span class="fc" id="L386">            try (final BitStreamReader sReader = new ByteArrayBitStreamReader(blob))</span>
            {
<span class="fc" id="L388">                final long s = sReader.readSignedBits(16);</span>
<span class="fc" id="L389">                assertEquals(-10000L, s);</span>
            }

<span class="fc" id="L392">            try (final BitStreamReader uReader = new ByteArrayBitStreamReader(blob))</span>
            {
<span class="fc" id="L394">                final long u = uReader.readBits(16);</span>
<span class="fc" id="L395">                assertEquals(55536L, u);</span>
            }
        }
<span class="fc" id="L398">    }</span>

    @Test
    public void signedBitfield3() throws IOException
    {
<span class="fc" id="L403">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc" id="L407">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L412">            }</span>
        });

<span class="fc" id="L415">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L417">            writer.writeSignedBits(-5, 10);</span>
<span class="fc" id="L418">            writer.writeSignedBits(-6, 10);</span>
<span class="fc" id="L419">            writer.writeSignedBits(-7, 10);</span>
<span class="fc" id="L420">            final byte[] blob = writer.toByteArray();</span>
<span class="fc" id="L421">            assertEquals(4, blob.length);</span>

<span class="fc" id="L423">            try (final BitStreamReader sReader = new ByteArrayBitStreamReader(blob))</span>
            {
<span class="fc" id="L425">                long s1 = sReader.readSignedBits(10);</span>
<span class="fc" id="L426">                long s2 = sReader.readSignedBits(10);</span>
<span class="fc" id="L427">                long s3 = sReader.readSignedBits(10);</span>
<span class="fc" id="L428">                assertEquals(-5L, s1);</span>
<span class="fc" id="L429">                assertEquals(-6L, s2);</span>
<span class="fc" id="L430">                assertEquals(-7L, s3);</span>
            }

<span class="fc" id="L433">            try (final BitStreamReader uReader = new ByteArrayBitStreamReader(blob))</span>
            {
<span class="fc" id="L435">                long u1 = uReader.readBits(10);</span>
<span class="fc" id="L436">                long u2 = uReader.readBits(10);</span>
<span class="fc" id="L437">                long u3 = uReader.readBits(10);</span>
<span class="fc" id="L438">                assertEquals(1019, u1);</span>
<span class="fc" id="L439">                assertEquals(1018, u2);</span>
<span class="fc" id="L440">                assertEquals(1017, u3);</span>
            }
        }
<span class="fc" id="L443">    }</span>

    @Test
    public void alignTo() throws IOException
    {
<span class="fc" id="L448">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L452">                reader.alignTo(10);</span>
<span class="fc" id="L453">                assertEquals(0, reader.getBitPosition());</span>
<span class="fc" id="L454">                reader.setBitPosition(reader.getBitPosition() + 1);</span>
<span class="fc" id="L455">                reader.alignTo(10);</span>
<span class="fc" id="L456">                assertEquals(10, reader.getBitPosition());</span>
<span class="fc" id="L457">            }</span>
        });
<span class="fc" id="L459">    }</span>

    @Test
    public void skipBits() throws IOException
    {
<span class="fc" id="L464">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L468">                assertEquals(0, reader.getBitPosition());</span>
<span class="fc" id="L469">                reader.setBitPosition(reader.getBitPosition() + 10);</span>
<span class="fc" id="L470">                assertEquals(10, reader.getBitPosition());</span>
<span class="fc" id="L471">            }</span>
        });
<span class="fc" id="L473">    }</span>

    @Test
    public void readLong() throws IOException
    {
<span class="fc" id="L478">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc" id="L482">                writer.writeLong(Long.MAX_VALUE);</span>
<span class="fc" id="L483">                writer.writeLong(Long.MIN_VALUE);</span>
<span class="fc" id="L484">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L489">                assertEquals(Long.MAX_VALUE, reader.readLong());</span>
<span class="fc" id="L490">                assertEquals(Long.MIN_VALUE, reader.readLong());</span>
<span class="fc" id="L491">            }</span>
        });
<span class="fc" id="L493">    }</span>

    @Test
    public void readInt() throws IOException
    {
<span class="fc" id="L498">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc" id="L502">                writer.writeInt(Integer.MAX_VALUE);</span>
<span class="fc" id="L503">                writer.writeInt(Integer.MIN_VALUE);</span>
<span class="fc" id="L504">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L509">                assertEquals(Integer.MAX_VALUE, reader.readInt());</span>
<span class="fc" id="L510">                assertEquals(Integer.MIN_VALUE, reader.readInt());</span>
<span class="fc" id="L511">            }</span>
        });
<span class="fc" id="L513">    }</span>

    @Test
    public void readString() throws IOException
    {
<span class="fc" id="L518">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc bfc" id="L522" title="All 2 branches covered.">                for (String s : DATA)</span>
                {
<span class="fc" id="L524">                    writeString(writer, s);</span>
                }
<span class="fc" id="L526">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc bfc" id="L531" title="All 2 branches covered.">                for (String s : DATA)</span>
                {
<span class="fc" id="L533">                    assertEquals(s, reader.readString());</span>
                }
<span class="fc" id="L535">            }</span>

            // write string in a format understood by ByteArrayBitStreamReader.readString()
            private void writeString(ImageOutputStream writer, String s) throws IOException
            {
                // see DATA below, all strings have length which fits to first byte of varint64
<span class="fc" id="L541">                writer.writeByte(s.length());</span>
<span class="fc" id="L542">                writer.write(s.getBytes(&quot;UTF8&quot;));</span>
<span class="fc" id="L543">            }</span>

<span class="fc" id="L545">            private /*static*/ final String DATA[] =</span>
            {
                &quot;&quot;,
                &quot;tmp&quot;,
                &quot;test&quot;
            };
        });
<span class="fc" id="L552">    }</span>

    @Test
    public void readBool() throws IOException
    {
<span class="fc" id="L557">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc bfc" id="L561" title="All 2 branches covered.">                for (boolean value : DATA)</span>
                {
<span class="fc" id="L563">                    writeBool(writer, value);</span>
                }
<span class="fc" id="L565">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc bfc" id="L570" title="All 2 branches covered.">                for (boolean value : DATA)</span>
                {
<span class="fc" id="L572">                    assertEquals(value, reader.readBool());</span>
                }
<span class="fc" id="L574">            }</span>

            // write boolean in a format understood by ByteArrayBitStreamReader.readBool()
            private void writeBool(ImageOutputStream writer, boolean value) throws IOException
            {
<span class="fc bfc" id="L579" title="All 2 branches covered.">                writer.writeBit(value ? 1 : 0);</span>
<span class="fc" id="L580">            }</span>

<span class="fc" id="L582">            private /*static*/ final boolean DATA[] =</span>
            {
                false,
                false,
                true
            };
        });
<span class="fc" id="L589">    }</span>

    @Test
    public void readBigInteger() throws IOException
    {
<span class="fc" id="L594">        writeReadTest(new WriteReadTestable(){</span>
            @Override
            public void write(ImageOutputStream writer) throws IOException
            {
<span class="fc" id="L598">                writer.writeLong(10);</span>
<span class="fc" id="L599">                writer.writeLong(Long.MAX_VALUE);</span>
<span class="fc" id="L600">            }</span>

            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L605">                assertEquals(BigInteger.TEN, reader.readBigInteger(64));</span>
<span class="fc" id="L606">                assertEquals(BigInteger.valueOf(Long.MAX_VALUE), reader.readBigInteger(64));</span>
<span class="fc" id="L607">            }</span>
        });
<span class="fc" id="L609">    }</span>

    @Test
    public void readSignedBigInteger() throws IOException
    {
<span class="fc" id="L614">        writeReadTest(new SampleWriteReadTest(){</span>
            @Override
            public void read(ByteArrayBitStreamReader reader) throws IOException
            {
<span class="fc" id="L618">                assertEquals(BigInteger.valueOf(103), reader.readSignedBigInteger(8));</span>
<span class="fc" id="L619">                assertEquals(BigInteger.valueOf(-8), reader.readSignedBigInteger(4));</span>
<span class="fc" id="L620">            }</span>
        });
<span class="fc" id="L622">    }</span>

    @Test
    public void readSignedBigInteger2() throws IOException
    {
<span class="fc" id="L627">        final BigInteger bigIntLongLong = BigInteger.valueOf(Long.MAX_VALUE);</span>
<span class="fc" id="L628">        final BigInteger bigIntLongLongLong = BigInteger.valueOf(Long.MAX_VALUE).add(BigInteger.ONE);</span>

<span class="fc" id="L630">        try (final ByteArrayBitStreamWriter babsw = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L632">            babsw.writeBigInteger(bigIntLongLong, 64);</span>
<span class="fc" id="L633">            babsw.writeBigInteger(bigIntLongLongLong, 64);</span>
<span class="fc" id="L634">            try (final ByteArrayBitStreamReader in = new ByteArrayBitStreamReader(babsw.toByteArray()))</span>
            {
<span class="fc" id="L636">                assertEquals(bigIntLongLong, in.readSignedBigInteger(64));</span>
<span class="fc" id="L637">                assertEquals(bigIntLongLongLong, in.readBigInteger(64));</span>
            }
        }
<span class="fc" id="L640">    }</span>

    @Test
    public void readFloat16() throws IOException
    {
<span class="fc" id="L645">        try (final ByteArrayBitStreamWriter babsw = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L647">            babsw.writeFloat16(1.0f);</span>
<span class="fc" id="L648">            try (final ByteArrayBitStreamReader in = new ByteArrayBitStreamReader(babsw.toByteArray()))</span>
            {
<span class="fc" id="L650">                assertEquals(1.0f, in.readFloat16(), 0);</span>
            }
        }
<span class="fc" id="L653">    }</span>

    @Test
    public void readTooMuch() throws IOException
    {
        // stream containing 1 byte of data
<span class="fc" id="L659">        try (final ByteArrayBitStreamReader in = new ByteArrayBitStreamReader(new byte[] {0x33}))</span>
        {
            // 5 out of 8 bits are attempted to read. expected to just go fine
<span class="fc" id="L662">            in.readBits(5);</span>
            // 9 out of 8 bits are attempted to read. expected to throw documented exception
<span class="pc" id="L664">            assertThrows(IOException.class, () -&gt; in.readBits(4));</span>
        }
<span class="fc" id="L666">    }</span>

    @Test
    public void readUnaligned63Bits() throws IOException
    {
<span class="fc" id="L671">        final byte[] data =</span>
        {
            (byte)0x0f, (byte)0xff, (byte)0xff, (byte)0xff, (byte)0xff, (byte)0xff, (byte)0xff, (byte)0xff,
            (byte)0xe0
        };

<span class="fc" id="L677">        try (final ByteArrayBitStreamReader reader = new ByteArrayBitStreamReader(data))</span>
        {
<span class="fc" id="L679">            assertEquals(0, reader.readBits(4));</span>
<span class="fc" id="L680">            assertEquals(0x7FFFFFFFFFFFFFFFL, reader.readBits(63));</span>
<span class="fc" id="L681">            assertEquals(0, reader.readBits(5));</span>
        }
<span class="fc" id="L683">    }</span>

    private interface WriteReadTestable
    {
        // don't use BitStreamWriter so that this tests solely the reader
        void write(ImageOutputStream writer) throws IOException;
        void read(ByteArrayBitStreamReader reader) throws IOException;
    }

    private abstract static class SampleWriteReadTest implements WriteReadTestable
    {
        public void write(ImageOutputStream writer) throws IOException
        {
<span class="fc" id="L696">            writer.writeBits(6, 4);</span>
<span class="fc" id="L697">            writer.writeBits(7, 4);</span>
<span class="fc" id="L698">            writer.writeBits(8, 4);</span>
<span class="fc" id="L699">            writer.writeBits(9, 4);</span>
<span class="fc" id="L700">            writer.writeBits(1, 4);</span>
<span class="fc" id="L701">            writer.writeBits(2, 4);</span>
<span class="fc" id="L702">            writer.writeBits(3, 4);</span>
<span class="fc" id="L703">            writer.writeBits(4, 4);</span>
<span class="fc" id="L704">            writer.writeBits(12, 4);</span>
<span class="fc" id="L705">            writer.writeBits(13, 4);</span>
<span class="fc" id="L706">            writer.writeBits(14, 4);</span>
<span class="fc" id="L707">            writer.writeBits(15, 4);</span>
<span class="fc" id="L708">        }</span>
    }

    private void writeReadTest(WriteReadTestable writeReadTest) throws IOException
    {
<span class="fc" id="L713">        try (final ByteArrayOutputStream outputStream = new ByteArrayOutputStream())</span>
        {
<span class="fc" id="L715">            try (final MemoryCacheImageOutputStream writer = new MemoryCacheImageOutputStream(outputStream))</span>
            {
<span class="fc" id="L717">                writeReadTest.write(writer);</span>
            }

<span class="fc" id="L720">            final byte[] data = outputStream.toByteArray();</span>
<span class="fc" id="L721">            try (final ByteArrayBitStreamReader reader = new ByteArrayBitStreamReader(data))</span>
            {
<span class="fc" id="L723">                writeReadTest.read(reader);</span>
            }
        }
<span class="fc" id="L726">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>