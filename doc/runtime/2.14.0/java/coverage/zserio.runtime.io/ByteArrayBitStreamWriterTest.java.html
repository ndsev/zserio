<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ByteArrayBitStreamWriterTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Zserio Java Runtime Library</a> &gt; <a href="index.source.html" class="el_package">zserio.runtime.io</a> &gt; <span class="el_source">ByteArrayBitStreamWriterTest.java</span></div><h1>ByteArrayBitStreamWriterTest.java</h1><pre class="source lang-java linenums">package zserio.runtime.io;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.math.BigInteger;
import javax.imageio.stream.ImageInputStream;
import javax.imageio.stream.MemoryCacheImageInputStream;

import org.junit.jupiter.api.Test;

<span class="fc" id="L14">public class ByteArrayBitStreamWriterTest</span>
{
    @Test
    public void test1() throws Exception
    {
<span class="fc" id="L19">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L23" title="All 2 branches covered.">                for (int value : DATA)</span>
                {
<span class="fc" id="L25">                    writer.writeBits(value, 4);</span>
                }
<span class="fc" id="L27">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L32" title="All 2 branches covered.">                for (int value : DATA)</span>
                {
<span class="fc" id="L34">                    assertEquals(value, reader.readBits(4));</span>
                }
<span class="fc" id="L36">            }</span>

<span class="fc" id="L38">            private final int[] DATA = {</span>
                    0x6,
                    0x7,
                    0x8,
                    0x9,
                    0x1,
                    0x2,
                    0x3,
                    0x4,
                    0xc,
                    0xd,
                    0xe,
                    0xf,
            };
        });
<span class="fc" id="L53">    }</span>

    @Test
    public void test2() throws Exception
    {
<span class="fc" id="L58">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc" id="L62">                writer.writeBits(6, 4);</span>
<span class="fc" id="L63">                writer.writeBits(0x78, 8);</span>
<span class="fc" id="L64">                writer.writeBits(0x91, 8);</span>
<span class="fc" id="L65">                writer.writeBits(0x23, 8);</span>
<span class="fc" id="L66">                writer.writeBits(0x4c, 8);</span>
<span class="fc" id="L67">                writer.writeBits(0xde, 8);</span>
<span class="fc" id="L68">                writer.writeBits(0xf, 4);</span>
<span class="fc" id="L69">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc" id="L74">                assertEquals(0x6, reader.readBits(4));</span>
<span class="fc" id="L75">                assertEquals(0x7, reader.readBits(4));</span>
<span class="fc" id="L76">                assertEquals(0x8, reader.readBits(4));</span>
<span class="fc" id="L77">                assertEquals(0x9, reader.readBits(4));</span>

<span class="fc" id="L79">                assertEquals(0x1, reader.readBits(4));</span>
<span class="fc" id="L80">                assertEquals(0x2, reader.readBits(4));</span>
<span class="fc" id="L81">                assertEquals(0x3, reader.readBits(4));</span>
<span class="fc" id="L82">                assertEquals(0x4, reader.readBits(4));</span>

<span class="fc" id="L84">                assertEquals(0xc, reader.readBits(4));</span>
<span class="fc" id="L85">                assertEquals(0xd, reader.readBits(4));</span>
<span class="fc" id="L86">                assertEquals(0xe, reader.readBits(4));</span>
<span class="fc" id="L87">                assertEquals(0xf, reader.readBits(4));</span>
<span class="fc" id="L88">            }</span>
        });
<span class="fc" id="L90">    }</span>

    @Test
    public void test3() throws Exception
    {
<span class="fc" id="L95">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc" id="L99">                writer.writeBits(6, 4);</span>
<span class="fc" id="L100">                writer.writeShort((short)0x7891);</span>
<span class="fc" id="L101">                writer.writeShort((short)0x234c);</span>
<span class="fc" id="L102">                writer.writeBits(0xd, 4);</span>
<span class="fc" id="L103">                writer.writeBits(0xef, 8);</span>
<span class="fc" id="L104">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc" id="L109">                assertEquals(0x6, reader.readBits(4));</span>
<span class="fc" id="L110">                assertEquals(0x7, reader.readBits(4));</span>
<span class="fc" id="L111">                assertEquals(0x8, reader.readBits(4));</span>
<span class="fc" id="L112">                assertEquals(0x9, reader.readBits(4));</span>

<span class="fc" id="L114">                assertEquals(0x1, reader.readBits(4));</span>
<span class="fc" id="L115">                assertEquals(0x2, reader.readBits(4));</span>
<span class="fc" id="L116">                assertEquals(0x3, reader.readBits(4));</span>
<span class="fc" id="L117">                assertEquals(0x4, reader.readBits(4));</span>

<span class="fc" id="L119">                assertEquals(0xc, reader.readBits(4));</span>
<span class="fc" id="L120">                assertEquals(0xd, reader.readBits(4));</span>
<span class="fc" id="L121">                assertEquals(0xe, reader.readBits(4));</span>
<span class="fc" id="L122">                assertEquals(0xf, reader.readBits(4));</span>
<span class="fc" id="L123">            }</span>
        });
<span class="fc" id="L125">    }</span>

    @Test
    public void test4() throws Exception
    {
<span class="fc" id="L130">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L132">            writer.writeShort((short)0x234c);</span>
<span class="fc" id="L133">            writer.writeBits(0xef, 8);</span>
<span class="fc" id="L134">            writer.alignTo(32);</span>

<span class="fc" id="L136">            final byte[] b = writer.toByteArray();</span>
<span class="fc" id="L137">            assertEquals(b.length * 8L, 32);</span>
        }
<span class="fc" id="L139">    }</span>

    @Test
    public void writeUnalignedData() throws IOException
    {
        // number expected to be written at offset
<span class="fc" id="L145">        final int testValue = 123;</span>

<span class="fc bfc" id="L147" title="All 2 branches covered.">        for (int offset = 0; offset &lt;= 63; ++offset)</span>
        {
<span class="fc" id="L149">            final int bufferByteSize = (8 + offset + 7) / 8;</span>
<span class="fc" id="L150">            try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter(bufferByteSize))</span>
            {
                // fill the buffer with 1s to check proper masking
<span class="fc bfc" id="L153" title="All 2 branches covered.">                for (int i = 0; i &lt; bufferByteSize; ++i)</span>
<span class="fc" id="L154">                    writer.writeBits(0xFF, 8);</span>

<span class="fc" id="L156">                writer.setBitPosition(0);</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">                if (offset != 0)</span>
<span class="fc" id="L159">                    writer.writeBits(0, offset);</span>
<span class="fc" id="L160">                writer.writeBits(testValue, 8);</span>

                // check written value
<span class="fc" id="L163">                byte[] writtenData = writer.toByteArray();</span>
<span class="fc" id="L164">                int writtenTestValue = ((int)writtenData[offset / 8]) &lt;&lt; (offset % 8);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">                if (offset % 8 != 0)</span>
<span class="fc" id="L166">                    writtenTestValue |= (0xFF &amp; writtenData[offset / 8 + 1]) &gt;&gt;&gt; (8 - (offset % 8));</span>
<span class="fc" id="L167">                assertEquals(testValue, writtenTestValue, &quot;offset: &quot; + offset);</span>
            }
        }
<span class="fc" id="L170">    }</span>

    @Test
    public void writeByte() throws IOException
    {
<span class="fc" id="L175">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L179" title="All 2 branches covered.">                for (byte value : DATA)</span>
                {
<span class="fc" id="L181">                    writer.writeByte(value);</span>
                }
<span class="fc" id="L183">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L188" title="All 2 branches covered.">                for (byte value : DATA)</span>
                {
<span class="fc" id="L190">                    assertEquals(value, reader.readByte());</span>
                }
<span class="fc" id="L192">            }</span>

<span class="fc" id="L194">            private final byte[] DATA = {</span>
                    0,
                    1,
                    -1,
                    Byte.MAX_VALUE,
                    Byte.MIN_VALUE,
            };
        });
<span class="fc" id="L202">    }</span>

    @Test
    public void writeShort() throws IOException
    {
<span class="fc" id="L207">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L211" title="All 2 branches covered.">                for (short value : DATA)</span>
                {
<span class="fc" id="L213">                    writer.writeShort(value);</span>
                }
<span class="fc" id="L215">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L220" title="All 2 branches covered.">                for (short value : DATA)</span>
                {
<span class="fc" id="L222">                    assertEquals(value, reader.readShort());</span>
                }
<span class="fc" id="L224">            }</span>

<span class="fc" id="L226">            private final short[] DATA = {</span>
                    0,
                    1,
                    -1,
                    Short.MAX_VALUE,
                    Short.MIN_VALUE,
            };
        });
<span class="fc" id="L234">    }</span>

    @Test
    public void writeInt() throws IOException
    {
<span class="fc" id="L239">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L243" title="All 2 branches covered.">                for (int value : DATA)</span>
                {
<span class="fc" id="L245">                    writer.writeInt(value);</span>
                }
<span class="fc" id="L247">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L252" title="All 2 branches covered.">                for (int value : DATA)</span>
                {
<span class="fc" id="L254">                    assertEquals(value, reader.readInt());</span>
                }
<span class="fc" id="L256">            }</span>

<span class="fc" id="L258">            private final int[] DATA = {</span>
                    0,
                    1,
                    -1,
                    Integer.MIN_VALUE,
                    Integer.MAX_VALUE,
                    127,
                    137,
            };
        });
<span class="fc" id="L268">    }</span>

    @Test
    public void writeLong() throws IOException
    {
<span class="fc" id="L273">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L277" title="All 2 branches covered.">                for (long value : DATA)</span>
                {
<span class="fc" id="L279">                    writer.writeLong(value);</span>
                }
<span class="fc" id="L281">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L286" title="All 2 branches covered.">                for (long value : DATA)</span>
                {
<span class="fc" id="L288">                    assertEquals(value, reader.readLong());</span>
                }
<span class="fc" id="L290">            }</span>

<span class="fc" id="L292">            private final long[] DATA = {</span>
                    0,
                    1,
                    -1,
                    Long.MAX_VALUE,
                    Long.MIN_VALUE,
                    1111111111L,
                    1212121212L,
            };
        });
<span class="fc" id="L302">    }</span>

    @Test
    public void writeUnsignedInt() throws IOException
    {
<span class="fc" id="L307">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L311" title="All 2 branches covered.">                for (long value : DATA)</span>
                {
<span class="fc" id="L313">                    writer.writeUnsignedInt(value);</span>
                }
<span class="fc" id="L315">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L320" title="All 2 branches covered.">                for (long value : DATA)</span>
                {
<span class="fc" id="L322">                    assertEquals(value, reader.readUnsignedInt());</span>
                }
<span class="fc" id="L324">            }</span>

<span class="fc" id="L326">            private final long[] DATA = {</span>
                    0,
                    1,
                    Integer.MAX_VALUE,
            };
        });
<span class="fc" id="L332">    }</span>

    @Test
    public void writeUnsignedByte() throws IOException
    {
<span class="fc" id="L337">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L341" title="All 2 branches covered.">                for (short value : DATA)</span>
                {
<span class="fc" id="L343">                    writer.writeUnsignedByte(value);</span>
                }
<span class="fc" id="L345">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L350" title="All 2 branches covered.">                for (short value : DATA)</span>
                {
<span class="fc" id="L352">                    assertEquals(value, reader.readUnsignedByte());</span>
                }
<span class="fc" id="L354">            }</span>

<span class="fc" id="L356">            private final short[] DATA = {</span>
                    5,
                    Byte.MAX_VALUE,
            };
        });
<span class="fc" id="L361">    }</span>

    @Test
    public void writeBigInteger() throws IOException
    {
<span class="fc" id="L366">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc" id="L370">                writer.writeBigInteger(BigInteger.valueOf(0x1), 4);</span>
<span class="fc" id="L371">                writer.writeBigInteger(BigInteger.valueOf(0x7), 4);</span>
<span class="fc" id="L372">                writer.writeBigInteger(BigInteger.valueOf(0x7f), 8);</span>
<span class="fc" id="L373">                writer.writeBigInteger(BigInteger.valueOf(0x7fff), 16);</span>
<span class="fc" id="L374">                writer.writeBigInteger(BigInteger.valueOf(0x7fffffff), 32);</span>
<span class="fc" id="L375">                writer.writeBigInteger(BigInteger.valueOf(0x7fffffffffffffffL), 64);</span>
<span class="fc" id="L376">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc" id="L381">                final int[] expectedBytes = {</span>
                        0x17, // 0x1, 0x7 nibbles combined
                        0x7f,
                        0x7f,
                        0xff,
                        0x7f,
                        0xff,
                        0xff,
                        0xff,
                        0x7f,
                        0xff,
                        0xff,
                        0xff,
                        0xff,
                        0xff,
                        0xff,
                        0xff,
                };
<span class="fc bfc" id="L399" title="All 2 branches covered.">                for (int value : expectedBytes)</span>
                {
<span class="fc" id="L401">                    assertEquals(value, reader.readUnsignedByte());</span>
                }
<span class="fc" id="L403">            }</span>
        });
<span class="fc" id="L405">    }</span>

    @Test
    public void writeFloat16() throws IOException
    {
<span class="fc" id="L410">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc" id="L414">                writer.writeFloat16(1.0f);</span>
<span class="fc" id="L415">                writer.writeFloat16(2.0f);</span>
<span class="fc" id="L416">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // hand-encoded values
<span class="fc" id="L422">                assertEquals(0x3c00, reader.readUnsignedShort());</span>
<span class="fc" id="L423">                assertEquals(0x4000, reader.readUnsignedShort());</span>
<span class="fc" id="L424">            }</span>
        });
<span class="fc" id="L426">    }</span>

    /**
     * Test capacity.
     *
     * @throws IOException if the writings and readings fail
     */
    @Test
    public void capacity() throws IOException
    {
<span class="fc" id="L436">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L438">            writer.writeInt(10);</span>
<span class="fc" id="L439">            writer.writeLong(10);</span>
<span class="fc" id="L440">            try (final ByteArrayBitStreamReader reader = new ByteArrayBitStreamReader(writer.toByteArray()))</span>
            {
<span class="fc" id="L442">                assertEquals(10, reader.readInt());</span>
<span class="fc" id="L443">                assertEquals(10, reader.readLong());</span>
            }
        }

<span class="fc" id="L447">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter(1234))</span>
        {
<span class="fc" id="L449">            writer.writeByte((byte)127);</span>
<span class="fc" id="L450">            writer.writeBits(7, 4);</span>
<span class="fc" id="L451">            writer.writeInt(123);</span>
<span class="fc" id="L452">            writer.writeLong(12345678910L);</span>

<span class="fc" id="L454">            try (final ByteArrayBitStreamReader reader = new ByteArrayBitStreamReader(writer.toByteArray()))</span>
            {
<span class="fc" id="L456">                assertEquals((byte)127, reader.readByte());</span>
<span class="fc" id="L457">                assertEquals(7, reader.readBits(4));</span>
<span class="fc" id="L458">                assertEquals(123, reader.readInt());</span>
<span class="fc" id="L459">                assertEquals(12345678910L, reader.readLong());</span>
            }
        }

<span class="pc" id="L463">        assertThrows(IllegalArgumentException.class, () -&gt; new ByteArrayBitStreamWriter(Integer.MAX_VALUE));</span>
<span class="pc" id="L464">        assertThrows(IllegalArgumentException.class, () -&gt; new ByteArrayBitStreamWriter(-1));</span>
<span class="fc" id="L465">    }</span>

    /**
     * Test the writeBool method.
     *
     * @throws IOException if the writing fails
     */
    @Test
    public void writeBool() throws IOException
    {
<span class="fc" id="L475">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
<span class="fc bfc" id="L479" title="All 2 branches covered.">                for (boolean value : DATA)</span>
                {
<span class="fc" id="L481">                    writer.writeBool(value);</span>
                }
<span class="fc" id="L483">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
<span class="fc bfc" id="L488" title="All 2 branches covered.">                for (boolean value : DATA)</span>
                {
<span class="fc bfc" id="L490" title="All 2 branches covered.">                    assertEquals(value, reader.readBit() != 0 ? true : false);</span>
                }
<span class="fc" id="L492">                assertEquals(DATA.length, getBitOffset(reader));</span>
<span class="fc" id="L493">            }</span>

<span class="fc" id="L495">            private final boolean[] DATA = {</span>
                    true,
                    false,
            };
        });
<span class="fc" id="L500">    }</span>

    /**
     * Test the growBuffer method.
     *
     * @throws IOException if the ByteArrayBitStreamWriter cannot be closed
     */
    @Test
    public void growBuffer() throws IOException
    {
<span class="fc" id="L510">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc bfc" id="L512" title="All 2 branches covered.">            for (int i = 0; i &lt; 8191; i++)</span>
            {
<span class="fc" id="L514">                writer.writeByte((byte)1);</span>
            }
<span class="fc" id="L516">            assertEquals(8191, writer.getBytePosition());</span>
        }
<span class="fc" id="L518">    }</span>

    @Test
    public void writeBitsInvalidNumException() throws IOException
    {
<span class="fc" id="L523">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L525">            final int numBits[] = {-1, 0, 65};</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">            for (int i = 0; i &lt; numBits.length; ++i)</span>
            {
<span class="fc" id="L528">                final int numBitsArg = numBits[i];</span>
<span class="pc" id="L529">                assertThrows(IllegalArgumentException.class, () -&gt; writer.writeBits(0x1L, numBitsArg));</span>
            } // for numbits
        }
<span class="fc" id="L532">    }</span>

    @Test
    public void writeBitsIllegalArgumentException() throws IOException
    {
<span class="fc" id="L537">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc bfc" id="L539" title="All 2 branches covered.">            for (int i = 1; i &lt; 64; i++)</span>
            {
<span class="fc" id="L541">                final long minSigned = -(1L &lt;&lt; (i - 1));</span>
<span class="fc" id="L542">                final long maxUnsigned = (1L &lt;&lt; (i)) - 1;</span>

<span class="fc" id="L544">                final long minSignedViolation = minSigned - 1;</span>
<span class="fc" id="L545">                final long maxUnsignedViolation = maxUnsigned + 1;</span>

<span class="fc" id="L547">                writer.writeBits(maxUnsigned, i);</span>
<span class="fc" id="L548">                writer.writeSignedBits(minSigned, i);</span>

<span class="fc" id="L550">                final int iArg = i;</span>
<span class="fc" id="L551">                assertThrows(IllegalArgumentException.class,</span>
                        ()
<span class="nc" id="L553">                                -&gt; writer.writeSignedBits(minSignedViolation, iArg),</span>
                        &quot;unexpected success writeBits: &quot; + minSignedViolation + &quot; # &quot; + i);

<span class="fc" id="L556">                assertThrows(IllegalArgumentException.class,</span>
                        ()
<span class="nc" id="L558">                                -&gt; writer.writeBits(maxUnsignedViolation, iArg),</span>
                        &quot;unexpected success writeBits: &quot; + maxUnsignedViolation + &quot; # &quot; + i);
            } // for numBits
        }
<span class="fc" id="L562">    }</span>

    @Test
    public void writeIllegalArgumentException() throws IOException
    {
<span class="fc" id="L567">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="pc" id="L569">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedByte((short)-1));</span>

<span class="pc" id="L571">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedShort(-1));</span>

<span class="pc" id="L573">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedInt(-1L));</span>

<span class="pc" id="L575">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedByte((short)(1 &lt;&lt; 8)));</span>

<span class="pc" id="L577">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedShort(1 &lt;&lt; 16));</span>

<span class="pc" id="L579">            assertThrows(IllegalArgumentException.class, () -&gt; writer.writeUnsignedInt(1L &lt;&lt; 32));</span>

            // Note: no range check for writeBigInteger
        }
<span class="fc" id="L583">    }</span>

    @Test
    public void writeVarInt16() throws IOException
    {
<span class="fc" id="L588">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
                // 1 byte
<span class="fc" id="L593">                writer.writeVarInt16((short)0);</span>
<span class="fc" id="L594">                writer.writeVarInt16((short)+0x3f);</span>
<span class="fc" id="L595">                writer.writeVarInt16((short)-0x3f);</span>

                // 2 bytes
<span class="fc" id="L598">                writer.writeVarInt16((short)+0x7f);</span>
<span class="fc" id="L599">                writer.writeVarInt16((short)-0x7f);</span>
<span class="fc" id="L600">                writer.writeVarInt16((short)+0x3fff);</span>
<span class="fc" id="L601">                writer.writeVarInt16((short)-0x3fff);</span>
<span class="fc" id="L602">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // 1 byte
<span class="fc" id="L608">                assertEquals(0x00, reader.readBits(8)); //  0</span>
<span class="fc" id="L609">                assertEquals(0x3f, reader.readBits(8)); //  111111b =  0x3f</span>
<span class="fc" id="L610">                assertEquals(0xbf, reader.readBits(8)); // -111111b = -0x3f</span>

                // 2 bytes
<span class="fc" id="L613">                assertEquals(0x407f, reader.readBits(16)); //  0b1111111 =  0x7f</span>
<span class="fc" id="L614">                assertEquals(0xc07f, reader.readBits(16)); // -0b1111111 = -0x7f</span>
<span class="fc" id="L615">                assertEquals(0x7fff, reader.readBits(16)); //  0b11111111111111 =  0x3fff</span>
<span class="fc" id="L616">                assertEquals(0xffff, reader.readBits(16)); // -0b11111111111111 = -0x3fff</span>
<span class="fc" id="L617">            }</span>
        });
<span class="fc" id="L619">    }</span>

    @Test
    public void writeVarInt32() throws IOException
    {
<span class="fc" id="L624">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
                // 1 byte
<span class="fc" id="L629">                writer.writeVarInt32(0);</span>
<span class="fc" id="L630">                writer.writeVarInt32(+0x3f);</span>
<span class="fc" id="L631">                writer.writeVarInt32(-0x3f);</span>

                // 2 bytes
<span class="fc" id="L634">                writer.writeVarInt32(+0x7f);</span>
<span class="fc" id="L635">                writer.writeVarInt32(-0x7f);</span>
<span class="fc" id="L636">                writer.writeVarInt32(+0x1fff);</span>
<span class="fc" id="L637">                writer.writeVarInt32(-0x1fff);</span>

                // 3 bytes
<span class="fc" id="L640">                writer.writeVarInt32(+0x3fff);</span>
<span class="fc" id="L641">                writer.writeVarInt32(-0x3fff);</span>
<span class="fc" id="L642">                writer.writeVarInt32(+0xfffff);</span>
<span class="fc" id="L643">                writer.writeVarInt32(-0xfffff);</span>

                // 4 bytes
<span class="fc" id="L646">                writer.writeVarInt32(+0x3fffff);</span>
<span class="fc" id="L647">                writer.writeVarInt32(-0x3fffff);</span>
<span class="fc" id="L648">                writer.writeVarInt32(+0xfffffff);</span>
<span class="fc" id="L649">                writer.writeVarInt32(-0xfffffff);</span>
<span class="fc" id="L650">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // 1 byte
<span class="fc" id="L656">                assertEquals(0x00, reader.readBits(8)); //  0</span>
<span class="fc" id="L657">                assertEquals(0x3f, reader.readBits(8)); //  111111b =  0x3f</span>
<span class="fc" id="L658">                assertEquals(0xbf, reader.readBits(8)); // -111111b = -0x3f</span>

                // 2 bytes
<span class="fc" id="L661">                assertEquals(0x407f, reader.readBits(16)); //  0b1111111 =  0x7f</span>
<span class="fc" id="L662">                assertEquals(0xc07f, reader.readBits(16)); // -0b1111111 = -0x7f</span>
<span class="fc" id="L663">                assertEquals(0x7f7f, reader.readBits(16)); //  0b1111111111111 =  0x1fff</span>
<span class="fc" id="L664">                assertEquals(0xff7f, reader.readBits(16)); // -0b1111111111111 = -0x1fff</span>

                // 3 bytes
<span class="fc" id="L667">                assertEquals(0x40ff7fL, reader.readBits(24)); //  0b11111111111111 =  0x3fff</span>
<span class="fc" id="L668">                assertEquals(0xc0ff7fL, reader.readBits(24)); // -0b11111111111111 = -0x3fff</span>
<span class="fc" id="L669">                assertEquals(0x7fff7fL, reader.readBits(24)); //  0b11111111111111 =  0xfffff</span>
<span class="fc" id="L670">                assertEquals(0xffff7fL, reader.readBits(24)); // -0b11111111111111 = -0xfffff</span>

                // 4 bytes
<span class="fc" id="L673">                assertEquals(0x40ffffffL, reader.readBits(32)); //  0x1fffff</span>
<span class="fc" id="L674">                assertEquals(0xc0ffffffL, reader.readBits(32)); // -0x1fffff</span>
<span class="fc" id="L675">                assertEquals(0x7fffffffL, reader.readBits(32)); //  0xfffffff</span>
<span class="fc" id="L676">                assertEquals(0xffffffffL, reader.readBits(32)); // -0xfffffff</span>
<span class="fc" id="L677">            }</span>
        });
<span class="fc" id="L679">    }</span>

    @Test
    public void writeVarUInt16() throws IOException
    {
<span class="fc" id="L684">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
                // 1 byte
<span class="fc" id="L689">                writer.writeVarUInt16((short)0);</span>
<span class="fc" id="L690">                writer.writeVarUInt16((short)0x7f);</span>

                // 2 bytes
<span class="fc" id="L693">                writer.writeVarUInt16((short)0xff);</span>
<span class="fc" id="L694">                writer.writeVarUInt16((short)0x7fff);</span>
<span class="fc" id="L695">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // 1 byte
<span class="fc" id="L701">                assertEquals(0x00, reader.readBits(8)); // 0</span>
<span class="fc" id="L702">                assertEquals(0x7f, reader.readBits(8)); // 1111111b = 0x7f</span>

                // 2 bytes
<span class="fc" id="L705">                assertEquals(0x80ff, reader.readBits(16)); // 0b11111111 = 0xff</span>
<span class="fc" id="L706">                assertEquals(0xffff, reader.readBits(16)); // 0b111111111111111 = 0x7fff</span>
<span class="fc" id="L707">            }</span>
        });
<span class="fc" id="L709">    }</span>

    @Test
    public void writeVarUInt32() throws IOException
    {
<span class="fc" id="L714">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
                // 1 byte
<span class="fc" id="L719">                writer.writeVarUInt32(0);</span>
<span class="fc" id="L720">                writer.writeVarUInt32(0x7f);</span>

                // 2 bytes
<span class="fc" id="L723">                writer.writeVarUInt32(0xff);</span>
<span class="fc" id="L724">                writer.writeVarUInt32(0x3fff);</span>

                // 3 bytes
<span class="fc" id="L727">                writer.writeVarUInt32(0x7fff);</span>
<span class="fc" id="L728">                writer.writeVarUInt32(0x1fffff);</span>

                // 4 bytes
<span class="fc" id="L731">                writer.writeVarUInt32(0x3fffff);</span>
<span class="fc" id="L732">                writer.writeVarUInt32(0x1fffffff);</span>
<span class="fc" id="L733">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // 1 byte
<span class="fc" id="L739">                assertEquals(0x00, reader.readBits(8)); // 0</span>
<span class="fc" id="L740">                assertEquals(0x7f, reader.readBits(8)); // 1111111b = 0x7f</span>

                // 2 bytes
<span class="fc" id="L743">                assertEquals(0x817f, reader.readBits(16));</span>
<span class="fc" id="L744">                assertEquals(0xff7f, reader.readBits(16));</span>

                // 3 bytes
<span class="fc" id="L747">                assertEquals(0x81ff7f, reader.readBits(24));</span>
<span class="fc" id="L748">                assertEquals(0xffff7f, reader.readBits(24));</span>

                // 4 bytes
<span class="fc" id="L751">                assertEquals(0x80ffffffL, reader.readBits(32));</span>
<span class="fc" id="L752">                assertEquals(0xffffffffL, reader.readBits(32));</span>
<span class="fc" id="L753">            }</span>
        });
<span class="fc" id="L755">    }</span>

    @Test
    public void writeVarSize() throws IOException
    {
<span class="fc" id="L760">        writeReadTest(new WriteReadTestable() {</span>
            @Override
            public void write(ByteArrayBitStreamWriter writer) throws IOException
            {
                // 1 byte
<span class="fc" id="L765">                writer.writeVarSize(0);</span>
<span class="fc" id="L766">                writer.writeVarSize(0x7f);</span>

                // 2 bytes
<span class="fc" id="L769">                writer.writeVarSize(0xff);</span>
<span class="fc" id="L770">                writer.writeVarSize(0x3fff);</span>

                // 3 bytes
<span class="fc" id="L773">                writer.writeVarSize(0x7fff);</span>
<span class="fc" id="L774">                writer.writeVarSize(0x1fffff);</span>

                // 4 bytes
<span class="fc" id="L777">                writer.writeVarSize(0x3fffff);</span>
<span class="fc" id="L778">                writer.writeVarSize(0xfffffff);</span>

                // 5 bytes
<span class="fc" id="L781">                writer.writeVarSize(0x1fffffff);</span>
<span class="fc" id="L782">                writer.writeVarSize(0x7fffffff);</span>
<span class="fc" id="L783">            }</span>

            @Override
            public void read(ImageInputStream reader) throws IOException
            {
                // 1 byte
<span class="fc" id="L789">                assertEquals(0x00, reader.readBits(8)); // 0</span>
<span class="fc" id="L790">                assertEquals(0x7f, reader.readBits(8)); // 1111111b = 0x7f</span>

                // 2 bytes
<span class="fc" id="L793">                assertEquals(0x817f, reader.readBits(16));</span>
<span class="fc" id="L794">                assertEquals(0xff7f, reader.readBits(16));</span>

                // 3 bytes
<span class="fc" id="L797">                assertEquals(0x81ff7f, reader.readBits(24));</span>
<span class="fc" id="L798">                assertEquals(0xffff7f, reader.readBits(24));</span>

                // 4 bytes
<span class="fc" id="L801">                assertEquals(0x81ffff7fL, reader.readBits(32));</span>
<span class="fc" id="L802">                assertEquals(0xffffff7fL, reader.readBits(32));</span>

                // 5 bytes
<span class="fc" id="L805">                assertEquals(0x80ffffffffL, reader.readBits(40));</span>
<span class="fc" id="L806">                assertEquals(0x83ffffffffL, reader.readBits(40));</span>
<span class="fc" id="L807">            }</span>
        });
<span class="fc" id="L809">    }</span>

    /**
     * Describes a test method.
     */
<span class="fc" id="L814">    private enum TestMethod</span>
    {
        /**
         * Test method: write aligned.
         */

<span class="fc" id="L820">        ALIGNED,</span>

        /**
         * Test method: write unaligned.
         */
<span class="fc" id="L825">        UNALIGNED;</span>
    }

    private interface WriteReadTestable
    {
        // don't use BitStreamReader so that this tests solely the writer
        void write(ByteArrayBitStreamWriter writer) throws IOException;
        void read(ImageInputStream reader) throws IOException;
    }

    private void writeReadTest(WriteReadTestable writeReadTest) throws IOException
    {
<span class="fc bfc" id="L837" title="All 2 branches covered.">        for (final TestMethod method : TestMethod.values())</span>
        {
<span class="fc" id="L839">            try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
            {

<span class="fc bfc" id="L842" title="All 2 branches covered.">                if (method == TestMethod.UNALIGNED)</span>
                {
<span class="fc" id="L844">                    writer.writeBits(1, 1);</span>
                }
<span class="fc" id="L846">                writeReadTest.write(writer);</span>

<span class="fc" id="L848">                final byte[] data = writer.toByteArray();</span>
<span class="fc bfc" id="L849" title="All 2 branches covered.">                if (method == TestMethod.UNALIGNED)</span>
<span class="fc" id="L850">                    trimBitFromLeft(data);</span>
<span class="fc" id="L851">                try (final ByteArrayInputStream inputStream = new ByteArrayInputStream(data);</span>
<span class="fc" id="L852">                        final MemoryCacheImageInputStream reader =</span>
                                new MemoryCacheImageInputStream(inputStream);)
                {
<span class="fc" id="L855">                    writeReadTest.read(reader);</span>
                }
            }
        }
<span class="fc" id="L859">    }</span>

    private static void trimBitFromLeft(byte[] data)
    {
<span class="fc" id="L863">        byte carry = 0;</span>
<span class="fc bfc" id="L864" title="All 2 branches covered.">        for (int i = data.length; i &gt; 0; --i)</span>
        {
<span class="fc" id="L866">            final int currentValue = data[i - 1] &amp; 0xff; // prevent sign extension later (signed byte-&gt;int)</span>

<span class="fc" id="L868">            data[i - 1] = (byte)((currentValue &lt;&lt; 1) | carry);</span>
<span class="fc" id="L869">            carry = (byte)(currentValue &gt;&gt;&gt; 7); // MSB move to carry</span>
        }
        // the last carry bit is trimmed off
<span class="fc" id="L872">    }</span>

    private static long getBitOffset(ImageInputStream inputStream) throws IOException
    {
<span class="fc" id="L876">        return 8 * inputStream.getStreamPosition() + inputStream.getBitOffset();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>