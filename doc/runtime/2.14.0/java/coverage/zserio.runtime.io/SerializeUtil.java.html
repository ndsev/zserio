<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SerializeUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Zserio Java Runtime Library</a> &gt; <a href="index.source.html" class="el_package">zserio.runtime.io</a> &gt; <span class="el_source">SerializeUtil.java</span></div><h1>SerializeUtil.java</h1><pre class="source lang-java linenums">package zserio.runtime.io;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.nio.file.Files;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

import zserio.runtime.ZserioEnum;
import zserio.runtime.ZserioError;

/**
 * Provides help methods for serialization and deserialization of generated objects.
 * &lt;p&gt;
 * These utilities are not used by generated code and they are provided only for user convenience.
 */
<span class="nc" id="L22">public final class SerializeUtil</span>
{
    /**
     * Serializes generated object to the bit buffer.
     * &lt;p&gt;
     * Before serialization, the method calls initializeOffsets() on the given zserio object.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * final BitBuffer bitBuffer = SerializeUtil.serialize(object);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param object Generated object to serialize.
     *
     * @return Bit buffer which represents generated object in binary format.
     */
    public static &lt;T extends Writer&gt; BitBuffer serialize(T object)
    {
<span class="fc" id="L44">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L46">            serializeToWriter(object, writer);</span>
<span class="fc" id="L47">            return new BitBuffer(writer.toByteArray(), writer.getBitPosition());</span>
        }
<span class="nc" id="L49">        catch (IOException exception)</span>
        {
<span class="nc" id="L51">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
        }
    }

    /**
     * Deserializes bit buffer to the generated object.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * final BitBuffer bitBuffer = SerializeUtil.serialize(object);
     * final SomeZserioObject readObject = SerializeUtil.deserialize(SomeZserioObject.class, bitBuffer);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param clazz Class instance of the generated object to deserialize.
     * @param bitBuffer Bit buffer which represents generated object in binary format.
     * @param arguments Additional arguments needed for reader constructor (optional).
     *
     * @return Generated object created from given bit buffer.
     */
    public static &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, BitBuffer bitBuffer, Object... arguments)
    {
<span class="fc" id="L76">        return deserializeFromBytes(clazz, bitBuffer.getBuffer(), arguments);</span>
    }

    /**
     * Serializes generated object to the byte array.
     * &lt;p&gt;
     * Before serialization, the method calls initializeOffsets() on the given zserio object.
     * &lt;p&gt;
     * This is a convenient method for users which do not need exact number of bits to which the given object
     * will be serialized.
     * &lt;p&gt;
     * However, it's still possible that not all bits of the last byte are used. In this case, only most
     * significant bits of the corresponding size are used.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * final byte[] buffer = SerializeUtil.serializeToBytes(object);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param object Generated object to serialize.
     *
     * @return Byte array which represents generated object in binary format.
     */
    public static &lt;T extends Writer&gt; byte[] serializeToBytes(T object)
    {
<span class="fc" id="L105">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L107">            serializeToWriter(object, writer);</span>
<span class="fc" id="L108">            return writer.toByteArray();</span>
        }
<span class="nc" id="L110">        catch (IOException exception)</span>
        {
<span class="nc" id="L112">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
        }
    }

    /**
     * Deserializes byte array to the generated object.
     * &lt;p&gt;
     * This method can potentially use all bits of the last byte even if not all of them were written during
     * serialization (because there is no way how to specify exact number of bits). Thus, it could allow reading
     * behind stream (possibly in case of damaged data).
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * final byte[] buffer = SerializeUtil.serializeToBytes(object);
     * final SomeZserioObject readObject = SerializeUtil.deserializeFromBytes(SomeZserioObject.class, buffer);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param clazz Class instance of the generated object to deserialize.
     * @param buffer Byte array which represents generated object in binary format.
     * @param arguments Additional arguments needed for reader constructor (optional).
     *
     * @return Generated object created from given byte array.
     */
    public static &lt;T&gt; T deserializeFromBytes(Class&lt;T&gt; clazz, byte[] buffer, Object... arguments)
    {
<span class="fc" id="L141">        try (final BitStreamReader reader = new ByteArrayBitStreamReader(buffer))</span>
        {
<span class="fc" id="L143">            return deserializeFromReader(clazz, reader, arguments);</span>
        }
<span class="nc" id="L145">        catch (IOException exception)</span>
        {
<span class="nc" id="L147">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
        }
    }

    /**
     * Serializes generated object to the file using file name.
     * &lt;p&gt;
     * Before serialization, the method calls initializeOffsets() on the given zserio object.
     * &lt;p&gt;
     * This is a convenient method for users to easily write given generated object to file.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * SerializeUtil.serializeToFile(object, &quot;FileName.bin&quot;);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param object Generated object to serialize.
     * @param fileName Name of the file to write.
     */
    public static &lt;T extends Writer&gt; void serializeToFile(T object, String fileName)
    {
<span class="fc" id="L172">        serializeToFile(object, new File(fileName));</span>
<span class="fc" id="L173">    }</span>

    /**
     * Serializes generated object to the file.
     * &lt;p&gt;
     * Before serialization, the method calls initializeOffsets() on the given zserio object.
     * &lt;p&gt;
     * This is a convenient method for users to easily write given generated object to file.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final SomeZserioObject object = new SomeZserioObject();
     * SerializeUtil.serializeToFile(object, &quot;FileName.bin&quot;);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param object Generated object to serialize.
     * @param file File to write.
     */
    public static &lt;T extends Writer&gt; void serializeToFile(T object, File file)
    {
<span class="fc" id="L196">        try (final ByteArrayBitStreamWriter writer = new ByteArrayBitStreamWriter())</span>
        {
<span class="fc" id="L198">            serializeToWriter(object, writer);</span>
<span class="fc" id="L199">            final byte[] bytes = writer.toByteArray();</span>
<span class="fc" id="L200">            try (final FileOutputStream outputStream = new FileOutputStream(file))</span>
            {
<span class="fc" id="L202">                outputStream.write(bytes);</span>
<span class="fc" id="L203">                outputStream.flush();</span>
            }
        }
<span class="nc" id="L206">        catch (IOException exception)</span>
        {
<span class="nc" id="L208">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
<span class="fc" id="L209">        }</span>
<span class="fc" id="L210">    }</span>

    /**
     * Deserializes file to the generated object using file name.
     * &lt;p&gt;
     * This is a convenient method for users to easily read given generated object from file.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final String fileName = &quot;FileName.bin&quot;;
     * final SomeZserioObject object = new SomeZserioObject();
     * SerializeUtil.serializeToFile(object, fileName);
     * final SomeZserioObject readObject = SerializeUtil.deserializeFromFile(SomeZserioObject.class, fileName);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param clazz Class instance of the generated object to deserialize.
     * @param fileName Name of the file which represents generated object in binary format.
     * @param arguments Additional arguments needed for reader constructor (optional).
     *
     * @return Generated object created from given file contents.
     */
    public static &lt;T&gt; T deserializeFromFile(Class&lt;T&gt; clazz, String fileName, Object... arguments)
    {
<span class="fc" id="L236">        return deserializeFromFile(clazz, new File(fileName), arguments);</span>
    }

    /**
     * Deserializes file to the generated object.
     * &lt;p&gt;
     * This is a convenient method for users to easily read given generated object from file.
     * &lt;p&gt;
     * Example:
     * &lt;blockquote&gt;&lt;pre&gt;
     * import zserio.runtime.io.SerializeUtil;
     *
     * final String fileName = &quot;FileName.bin&quot;;
     * final SomeZserioObject object = new SomeZserioObject();
     * SerializeUtil.serializeToFile(object, fileName);
     * final SomeZserioObject readObject = SerializeUtil.deserializeFromFile(SomeZserioObject.class, fileName);
     * &lt;/pre&gt;&lt;/blockquote&gt;
     *
     * @param &lt;T&gt; Type of generated object.
     * @param clazz Class instance of the generated object to deserialize.
     * @param file File which represents generated object in binary format.
     * @param arguments Additional arguments needed for reader constructor (optional).
     *
     * @return Generated object created from given file contents.
     */
    public static &lt;T&gt; T deserializeFromFile(Class&lt;T&gt; clazz, File file, Object... arguments)
    {
        try
        {
<span class="fc" id="L265">            final byte[] fileContent = Files.readAllBytes(file.toPath());</span>
<span class="fc" id="L266">            try (final BitStreamReader reader = new ByteArrayBitStreamReader(fileContent))</span>
            {
<span class="fc" id="L268">                return deserializeFromReader(clazz, reader, arguments);</span>
            }
        }
<span class="nc" id="L271">        catch (IOException exception)</span>
        {
<span class="nc" id="L273">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
        }
    }

    private static &lt;T extends Writer&gt; void serializeToWriter(T object, BitStreamWriter writer)
            throws IOException
    {
<span class="fc" id="L280">        object.initializeOffsets(writer.getBitPosition());</span>
<span class="fc" id="L281">        object.write(writer);</span>
<span class="fc" id="L282">    }</span>

    private static &lt;T&gt; T deserializeFromReader(Class&lt;T&gt; clazz, BitStreamReader reader, Object... arguments)
    {
        try
        {
<span class="fc bfc" id="L288" title="All 2 branches covered.">            if (Arrays.asList(clazz.getInterfaces()).contains(ZserioEnum.class))</span>
            {
<span class="fc" id="L290">                final Method method = clazz.getMethod(&quot;readEnum&quot;, BitStreamReader.class);</span>
<span class="fc" id="L291">                return clazz.cast(method.invoke(null, reader));</span>
            }
            else
            {
<span class="fc" id="L295">                final Class&lt;?&gt;[] ctorArgumentTypes = new Class&lt;?&gt;[arguments.length + 1];</span>
<span class="fc" id="L296">                ctorArgumentTypes[0] = BitStreamReader.class;</span>
                // please note that arguments are always boxed and object parameters are always unboxed
<span class="fc bfc" id="L298" title="All 2 branches covered.">                for (int i = 0; i &lt; arguments.length; ++i)</span>
<span class="fc" id="L299">                    ctorArgumentTypes[i + 1] = toUnboxedClass(arguments[i].getClass());</span>
<span class="fc" id="L300">                final Constructor&lt;T&gt; constructor = clazz.getConstructor(ctorArgumentTypes);</span>

<span class="fc" id="L302">                final Object[] ctorArguments = new Object[arguments.length + 1];</span>
<span class="fc" id="L303">                ctorArguments[0] = reader;</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">                for (int i = 0; i &lt; arguments.length; ++i)</span>
<span class="fc" id="L305">                    ctorArguments[i + 1] = arguments[i];</span>
<span class="fc" id="L306">                return constructor.newInstance(ctorArguments);</span>
            }
        }
<span class="fc" id="L309">        catch (NoSuchMethodException | SecurityException | InstantiationException | IllegalAccessException |</span>
                IllegalArgumentException | InvocationTargetException exception)
        {
<span class="fc" id="L312">            throw new ZserioError(&quot;SerializeUtil: &quot; + exception, exception);</span>
        }
    }

    private static Class&lt;?&gt; toUnboxedClass(Class&lt;?&gt; clazz)
    {
<span class="fc" id="L318">        final Class&lt;?&gt; unboxedClazz = boxedToUnboxedClassMap.get(clazz);</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        return (unboxedClazz == null) ? clazz : unboxedClazz;</span>
    }

<span class="fc" id="L322">    private static final Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; boxedToUnboxedClassMap = new HashMap&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt;();</span>
    static
    {
<span class="fc" id="L325">        boxedToUnboxedClassMap.put(Boolean.class, boolean.class);</span>
<span class="fc" id="L326">        boxedToUnboxedClassMap.put(Byte.class, byte.class);</span>
<span class="fc" id="L327">        boxedToUnboxedClassMap.put(Short.class, short.class);</span>
<span class="fc" id="L328">        boxedToUnboxedClassMap.put(Character.class, char.class);</span>
<span class="fc" id="L329">        boxedToUnboxedClassMap.put(Integer.class, int.class);</span>
<span class="fc" id="L330">        boxedToUnboxedClassMap.put(Long.class, long.class);</span>
<span class="fc" id="L331">        boxedToUnboxedClassMap.put(Float.class, float.class);</span>
<span class="fc" id="L332">        boxedToUnboxedClassMap.put(Double.class, double.class);</span>
<span class="fc" id="L333">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>