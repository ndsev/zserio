<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidationSqliteUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Zserio Java Runtime Library</a> &gt; <a href="index.source.html" class="el_package">zserio.runtime.validation</a> &gt; <span class="el_source">ValidationSqliteUtil.java</span></div><h1>ValidationSqliteUtil.java</h1><pre class="source lang-java linenums">package zserio.runtime.validation;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.HashMap;
import java.util.Map;

/**
 * Contains SQL utilities need for validation code generated by Zserio.
 */
<span class="nc" id="L14">public final class ValidationSqliteUtil</span>
{
    /**
     * Describes the table column.
     */
    public static final class ColumnDescription
    {
        /**
         * Constructs table column description from all properties.
         *
         * @param name         Name of the column.
         * @param type         Column SQLite data type (&quot;INTEGER&quot;, &quot;REAL&quot;, &quot;TEXT&quot; or &quot;BLOB&quot;).
         * @param isNotNull    true if column has &quot;NOT NULL&quot; constraint.
         * @param isPrimaryKey true if column is primary key.
         */
        public ColumnDescription(String name, String type, boolean isNotNull, boolean isPrimaryKey)
<span class="fc" id="L30">        {</span>
<span class="fc" id="L31">            this.name = name;</span>
<span class="fc" id="L32">            this.type = type;</span>
<span class="fc" id="L33">            this.isNotNull = isNotNull;</span>
<span class="fc" id="L34">            this.isPrimaryKey = isPrimaryKey;</span>
<span class="fc" id="L35">        }</span>

        /**
         * Gets the column name.
         *
         * @return Column name.
         */
        public String getName()
        {
<span class="fc" id="L44">            return name;</span>
        }

        /**
         * Gets the column SQLite data type.
         *
         * @return Column SQLite data type (&quot;INTEGER&quot;, &quot;REAL&quot;, &quot;TEXT&quot; or &quot;BLOB&quot;).
         */
        public String getType()
        {
<span class="fc" id="L54">            return type;</span>
        }

        /**
         * Gets &quot;NOT NULL&quot; constaint flag of this column.
         *
         * @return true if column has &quot;NOT NULL&quot; constraint.
         */
        public boolean isNotNull()
        {
<span class="fc" id="L64">            return isNotNull;</span>
        }

        /**
         * Gets primary key flag of this column.
         *
         * @return true if this column is primary key.
         */
        public boolean isPrimaryKey()
        {
<span class="fc" id="L74">            return isPrimaryKey;</span>
        }

        private final String name;
        private final String type;
        private final boolean isNotNull;
        private final boolean isPrimaryKey;
    };

    /**
     * Returns a map of column names to column description for given SQLite table.
     *
     * @param connection     Database connection to use.
     * @param attachedDbName Attached database name if table is relocated in different database or null.
     * @param tableName      Name of the table to get column types of.
     *
     * @return Map of column names to column description.
     *
     * @throws SQLException Throws in case of any SQLite error.
     */
    public static Map&lt;String, ColumnDescription&gt; getTableSchema(
            Connection connection, String attachedDbName, String tableName) throws SQLException
    {
<span class="fc" id="L97">        Map&lt;String, ColumnDescription&gt; columnTypes = new HashMap&lt;String, ColumnDescription&gt;();</span>

        // prepare SQL query
<span class="fc" id="L100">        final StringBuilder sqlQuery = new StringBuilder(&quot;PRAGMA &quot;);</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (attachedDbName != null)</span>
        {
<span class="nc" id="L103">            sqlQuery.append(attachedDbName);</span>
<span class="nc" id="L104">            sqlQuery.append('.');</span>
        }
<span class="fc" id="L106">        sqlQuery.append(&quot;table_info(&quot;);</span>
<span class="fc" id="L107">        sqlQuery.append(tableName);</span>
<span class="fc" id="L108">        sqlQuery.append(&quot;)&quot;);</span>

        // get table info
<span class="fc" id="L111">        try (final PreparedStatement statement = connection.prepareStatement(sqlQuery.toString());</span>
<span class="fc" id="L112">                final ResultSet resultSet = statement.executeQuery();)</span>
        {
<span class="fc bfc" id="L114" title="All 2 branches covered.">            while (resultSet.next())</span>
            {
<span class="fc" id="L116">                final String columnName = resultSet.getString(2);</span>
<span class="fc" id="L117">                final String columnType = resultSet.getString(3);</span>
<span class="fc" id="L118">                final boolean isNullable = resultSet.getBoolean(4);</span>
<span class="fc" id="L119">                final int primaryKeyIndex = resultSet.getInt(6);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">                columnTypes.put(columnName,</span>
                        new ColumnDescription(columnName, columnType, isNullable, primaryKeyIndex != 0));
<span class="fc" id="L122">            }</span>
        }

<span class="fc" id="L125">        return columnTypes;</span>
    }

    /**
     * Checks if hidden column exits in given SQLite table.
     *
     * @param connection       Database connection to use.
     * @param attachedDbName   Attached database name if table is relocated in different database or null.
     * @param tableName        Name of the table where to check hidden column.
     * @param hiddenColumnName Name of hidden column to check.
     *
     * @return true if hidden column exists in given SQLite table.
     */
    public static boolean isHiddenColumnInTable(
            Connection connection, String attachedDbName, String tableName, String hiddenColumnName)
    {
        // prepare SQL query
<span class="fc" id="L142">        final StringBuilder sqlQuery = new StringBuilder(&quot;SELECT &quot;);</span>
<span class="fc" id="L143">        sqlQuery.append(hiddenColumnName);</span>
<span class="fc" id="L144">        sqlQuery.append(&quot; FROM &quot;);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (attachedDbName != null)</span>
        {
<span class="nc" id="L147">            sqlQuery.append(attachedDbName);</span>
<span class="nc" id="L148">            sqlQuery.append('.');</span>
        }
<span class="fc" id="L150">        sqlQuery.append(tableName);</span>
<span class="fc" id="L151">        sqlQuery.append(&quot; LIMIT 0&quot;);</span>

        // try select to check if hidden column exists
<span class="fc" id="L154">        try (final PreparedStatement statement = connection.prepareStatement(sqlQuery.toString()))</span>
        {
<span class="fc" id="L156">            return statement.execute();</span>
        }
<span class="fc" id="L158">        catch (SQLException exception)</span>
        {
<span class="fc" id="L160">            return false;</span>
        }
    }

    /**
     * Converts SQL type returned by ResultSetMetaData.getColumnType.
     *
     * It converts only types which belongs to one of Types.INTEGER, Types.REAL, Types.VARCHAR, Types.BLOB or
     * Types.NULL to SQLite type. All others types are left unchanged (possibly unknown for SQLite).
     *
     * @param columnType SQL column type returned by ResultSetMetaData.getColumnType().
     *
     * @return SQLite column type.
     */
    public static int sqlTypeToSqliteType(int columnType)
    {
        // Zserio supports only INTEGER, REAL, VARCHAR and BLOB,
        // however we check also other cases in order to support different versions of Xerial JDBC driver
<span class="pc bpc" id="L178" title="3 of 5 branches missed.">        switch (columnType)</span>
        {
        case Types.BOOLEAN:
        case Types.TINYINT:
        case Types.SMALLINT:
        case Types.BIGINT: // returned only by older versions of Xerial
<span class="nc" id="L184">            return Types.INTEGER;</span>
        case Types.DECIMAL:
        case Types.DOUBLE:
        case Types.FLOAT:
<span class="fc" id="L188">            return Types.REAL;</span>
        case Types.CHAR:
        case Types.CLOB:
<span class="nc" id="L191">            return Types.VARCHAR;</span>
        case Types.BINARY:
<span class="nc" id="L193">            return Types.BLOB;</span>
        default:
<span class="fc" id="L195">            return columnType;</span>
        }
    }

    /**
     * Gets name of the given SQLite column type.
     *
     * Note that Zserio supports only INTEGER, REAL, VARCHAR (&quot;TEXT&quot;) and BLOB.
     *
     * Latest Xerial JDBC driver uses sqlite3_column_decltype in ResultSetMetaData.getColumnTypeName
     * and thus doesn't reflect current dynamic type and therefore we cannon use it.
     *
     * @param columnType SQLite column type returned from sqlTypeToSqliteType.
     *
     * @return SQLite column type name.
     */
    public static String sqliteColumnTypeName(int columnType)
    {
<span class="nc bnc" id="L213" title="All 6 branches missed.">        switch (columnType)</span>
        {
        case Types.INTEGER:
<span class="nc" id="L216">            return &quot;INTEGER&quot;;</span>
        case Types.REAL:
<span class="nc" id="L218">            return &quot;REAL&quot;;</span>
        case Types.VARCHAR:
<span class="nc" id="L220">            return &quot;TEXT&quot;;</span>
        case Types.BLOB:
<span class="nc" id="L222">            return &quot;BLOB&quot;;</span>
        case Types.NULL:
<span class="nc" id="L224">            return &quot;NULL&quot;;</span>
        default:
<span class="nc" id="L226">            return &quot;UNKNOWN (&quot; + columnType + &quot;)&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>